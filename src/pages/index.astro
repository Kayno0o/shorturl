---
import type { Link, LinkAnalytics } from '../api/orm/entities/link'
import { getUserFromJwt } from '../api/middleware/auth'
import CreateLinkForm from '../components/CreateLinkForm.astro'
import DashboardHeader from '../components/DashboardHeader.astro'
import FeaturesGrid from '../components/FeaturesGrid.astro'
import HeroSection from '../components/HeroSection.astro'
import LinksGrid from '../components/LinksGrid.astro'
import QuickStats from '../components/QuickStats.astro'
import Layout from '../layouts/Layout.astro'
import { countryNames } from '../utils/countries'

const cookies = Astro.cookies
const user = getUserFromJwt(cookies.get('jwtToken')?.value)

const linksRes = await fetch(new URL('/api/link', `https://${import.meta.env.APP_URL}`), {
  headers: {
    Cookie: Astro.request.headers.get('cookie') || '',
  },
})
let links: Link[]
try {
  links = await linksRes.json()
}
catch (e) {
  links = []
  console.error(linksRes.url, linksRes.status)
}

const totalClicks = links.reduce((sum, link) => sum + (link.clickCount || 0), 0)

const countriesAggregate: Record<string, number> = {}

for (const link of links) {
  try {
    const analytics: LinkAnalytics = JSON.parse(link.analytics || '{}')
    if (analytics.countries) {
      for (const [country, count] of Object.entries(analytics.countries))
        countriesAggregate[country] = (countriesAggregate[country] || 0) + count
    }
  }
  catch {
  }
}

const topCountries = Object.entries(countriesAggregate)
  .map(([code, count]) => ({
    code,
    name: countryNames[code] || code,
    count,
  }))
  .sort((a, b) => b.count - a.count)
---

<Layout title="URL Shortener">
  {user
    ? (
      <div class="space-y-8">
        <DashboardHeader username={user.username} />

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <CreateLinkForm />
          </div>

          <QuickStats linkCount={links.length} totalClicks={totalClicks} user={user} topCountries={topCountries} />
        </div>

        <LinksGrid links={links} shortUrl={import.meta.env.SHORT_URL} user={user} />
      </div>
    )
    : (
      <div class="max-w-4xl mx-auto">
        <HeroSection />
        <FeaturesGrid />
      </div>
    )}
</Layout>
