---
import type { Link } from '../api/orm/entities/link'
import { getUserFromJwt } from '../api/middleware/auth'
import CreateLinkForm from '../components/CreateLinkForm.astro'
import DashboardHeader from '../components/DashboardHeader.astro'
import FeaturesGrid from '../components/FeaturesGrid.astro'
import HeroSection from '../components/HeroSection.astro'
import LinksGrid from '../components/LinksGrid.astro'
import QuickStats from '../components/QuickStats.astro'
import Layout from '../layouts/Layout.astro'

const cookies = Astro.cookies
const user = getUserFromJwt(cookies.get('jwtToken')?.value)

const linksRes = await fetch(new URL('/api/link', `https://${import.meta.env.APP_URL}`), {
  headers: {
    Cookie: Astro.request.headers.get('cookie') || '',
  },
})
let links: Link[]
try {
  links = await linksRes.json()
}
catch (e) {
  links = []
  console.error(linksRes.url, linksRes.status)
}

const totalClicks = links.reduce((sum, link) => sum + (link.clickCount || 0), 0)
---

<Layout title="URL Shortener">
  {user
    ? (
      <div class="space-y-8">
        <DashboardHeader username={user.username} />

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <CreateLinkForm />
          </div>

          <QuickStats linkCount={links.length} totalClicks={totalClicks} user={user} />
        </div>

        <LinksGrid links={links} shortUrl={import.meta.env.SHORT_URL} user={user} />
      </div>
    )
    : (
      <div class="max-w-4xl mx-auto">
        <HeroSection />
        <FeaturesGrid />
      </div>
    )}
</Layout>
